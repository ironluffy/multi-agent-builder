---
id: WP03.9
task_id: T041
title: Create basic message queue for agent communication in src/infrastructure/SharedQueue.ts
phase: Phase 3 - User Story 1 (MVP)
lane: done
status: pending
created_at: 2025-11-21
started_at: 2025-11-22T13:37:05Z
completed_at: 2025-11-22T13:42:49Z
estimated_time: 35min
actual_time: null
depends_on: [T028, T032]
files_modified: []
---

# WP03.9: Create basic message queue for agent communication [US1]

## Objective

Create a basic SharedQueue implementation for asynchronous message passing between agents, providing send and receive methods with database persistence.

## File Paths

- `src/infrastructure/SharedQueue.ts`

## Work Content

1. Create SharedQueue class with:
   - send(sender_id, recipient_id, content): Send message
   - receive(recipient_id): Retrieve next pending message
   - markProcessed(message_id): Mark message as processed
   - getQueueDepth(recipient_id): Get pending message count
2. Implement database-backed queue:
   - Insert messages with 'pending' status
   - Retrieve messages FIFO (created_at ASC)
   - Update message status on delivery
3. Add basic priority support (default 0)
4. Add logging for message operations
5. Export SharedQueue singleton

## Acceptance Criteria

- [ ] SharedQueue class with send/receive methods
- [ ] Messages persisted to database
- [ ] FIFO ordering for message retrieval
- [ ] Message status tracking (pending → delivered → processed)
- [ ] getQueueDepth() returns pending count
- [ ] Logging for queue operations
- [ ] Singleton pattern for shared access

## Dependencies

Depends on T028 (Message model) and T032 (SharedDatabase).

## Parallel Execution

Can run in parallel with T042 (BudgetService).

## Unit Tests

Unit tests in tests/unit/infrastructure/SharedQueue.test.ts for queue operations.

## Git History

**Commits**: Include [WP03.9] in commit message

## Activity Log

- 2025-11-21: Task created

- 2025-11-22T13:37:05Z: Moved from planned to doing

- 2025-11-22T13:37:05Z: Moved from doing to for_review

- 2025-11-22T13:42:49Z: Moved from for_review to done
