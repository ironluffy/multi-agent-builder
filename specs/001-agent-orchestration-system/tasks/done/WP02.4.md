---
id: WP02.4
task_id: T018
title: Define Message table with priority, FIFO ordering, status fields
phase: Phase 2 - Foundational
lane: done
status: pending
created_at: 2025-11-21
started_at: 2025-11-22T13:31:20Z
completed_at: 2025-11-22T13:40:49Z
estimated_time: 20min
actual_time: null
depends_on: [T015]
files_modified: []
---

# WP02.4: Define Message table schema

## Objective

Define the Message table schema with priority-based FIFO ordering, sender/recipient relationships, and status tracking for asynchronous message passing.

## File Paths

- `migrations/001_initial_schema.sql` (Message table section)

## Work Content

1. Define message_status enum type:
   - 'pending', 'delivered', 'processed', 'failed'
2. Create Message table with columns:
   - id UUID PRIMARY KEY
   - sender_id UUID REFERENCES Agent(id) NOT NULL
   - recipient_id UUID REFERENCES Agent(id) NOT NULL
   - content TEXT NOT NULL
   - priority INTEGER DEFAULT 0
   - status message_status DEFAULT 'pending'
   - created_at TIMESTAMP DEFAULT NOW()
   - delivered_at TIMESTAMP
   - processed_at TIMESTAMP
   - metadata JSONB
3. Add composite index on (recipient_id, status, priority, created_at) for FIFO retrieval
4. Add CHECK constraint: priority >= 0

## Acceptance Criteria

- [ ] message_status enum type created
- [ ] Message table includes sender_id and recipient_id foreign keys
- [ ] priority field with default 0
- [ ] status field with state machine values
- [ ] Composite index for FIFO + priority ordering
- [ ] CHECK constraint validates priority >= 0
- [ ] Timestamp fields for delivery and processing tracking

## Dependencies

Depends on T015 (migration file) and T016 (Agent table exists for foreign keys).

## Parallel Execution

Part of T015's migration file - sequential after T016.

## Unit Tests

Message ordering and FIFO validated in integration tests (Phase 5, US3).

## Git History

**Commits**: Include [WP02.4] in commit message

## Activity Log

- 2025-11-21: Task created

- 2025-11-22T13:31:20Z: Moved from planned to doing

- 2025-11-22T13:32:04Z: Moved from doing to for_review

- 2025-11-22T13:40:49Z: Moved from for_review to done
