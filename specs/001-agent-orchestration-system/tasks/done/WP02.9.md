---
id: WP02.9
task_id: T023
title: Create budget allocation trigger allocate_child_budget() in migration
phase: Phase 2 - Foundational
lane: done
status: pending
created_at: 2025-11-21
started_at: 2025-11-22T13:31:20Z
completed_at: 2025-11-22T13:40:49Z
estimated_time: 30min
actual_time: null
depends_on: [T015, T016, T017]
files_modified: []
---

# WP02.9: Create budget allocation trigger

## Objective

Create a PostgreSQL trigger function allocate_child_budget() that automatically deducts from parent's budget when allocating budget to a child agent.

## File Paths

- `migrations/001_initial_schema.sql` (triggers section)

## Work Content

1. Create PL/pgSQL function allocate_child_budget():
   - Triggered BEFORE INSERT on Budget table
   - Check if agent has a parent (via Hierarchy table)
   - If parent exists, deduct allocated_tokens from parent's budget
   - Validate parent has sufficient available budget
   - Update parent's reserved_tokens
   - Raise exception if insufficient budget
2. Create trigger:
   ```sql
   CREATE TRIGGER budget_allocation_trigger
   BEFORE INSERT ON Budget
   FOR EACH ROW
   EXECUTE FUNCTION allocate_child_budget();
   ```
3. Add transaction safety and error handling
4. Document trigger behavior in migration comments

## Acceptance Criteria

- [ ] allocate_child_budget() function created
- [ ] Trigger fires BEFORE INSERT on Budget table
- [ ] Parent budget automatically decremented
- [ ] Insufficient budget raises exception
- [ ] Transaction-safe implementation
- [ ] Error messages are descriptive

## Dependencies

Depends on T015 (migration file), T016 (Agent table), T017 (Budget table).

## Parallel Execution

Part of T015's migration file - sequential after Budget table defined.

## Unit Tests

Budget allocation logic validated in integration tests (Phase 7, US5).

## Git History

**Commits**: Include [WP02.9] in commit message

## Activity Log

- 2025-11-21: Task created

- 2025-11-22T13:31:20Z: Moved from planned to doing

- 2025-11-22T13:32:04Z: Moved from doing to for_review

- 2025-11-22T13:40:49Z: Moved from for_review to done
