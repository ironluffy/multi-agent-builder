---
id: WP02.3
task_id: T017
title: Define Budget table with allocated/used/reserved columns and constraints
phase: Phase 2 - Foundational
lane: done
status: pending
created_at: 2025-11-21
started_at: 2025-11-22T13:31:20Z
completed_at: 2025-11-22T13:40:49Z
estimated_time: 20min
actual_time: null
depends_on: [T015]
files_modified: []
---

# WP02.3: Define Budget table schema

## Objective

Define the Budget table schema with allocated, used, and reserved token columns, ensuring budget tracking integrity with constraints.

## File Paths

- `migrations/001_initial_schema.sql` (Budget table section)

## Work Content

1. Create Budget table with columns:
   - id UUID PRIMARY KEY
   - agent_id UUID REFERENCES Agent(id) UNIQUE NOT NULL
   - allocated_tokens INTEGER NOT NULL DEFAULT 0
   - used_tokens INTEGER NOT NULL DEFAULT 0
   - reserved_tokens INTEGER NOT NULL DEFAULT 0
   - created_at TIMESTAMP DEFAULT NOW()
   - updated_at TIMESTAMP DEFAULT NOW()
2. Add CHECK constraints:
   - allocated_tokens >= 0
   - used_tokens >= 0
   - reserved_tokens >= 0
   - used_tokens + reserved_tokens <= allocated_tokens
3. Add index on agent_id
4. Add trigger for updated_at timestamp

## Acceptance Criteria

- [ ] Budget table includes allocated/used/reserved columns
- [ ] agent_id foreign key references Agent(id) with UNIQUE constraint
- [ ] CHECK constraints prevent negative values
- [ ] CHECK constraint ensures: used + reserved <= allocated
- [ ] Index created on agent_id for fast lookups
- [ ] updated_at trigger configured

## Dependencies

Depends on T015 (migration file) and T016 (Agent table exists for foreign key).

## Parallel Execution

Part of T015's migration file - sequential after T016.

## Unit Tests

Budget constraint validation tested in integration tests (Phase 7).

## Git History

**Commits**: Include [WP02.3] in commit message

## Activity Log

- 2025-11-21: Task created

- 2025-11-22T13:31:20Z: Moved from planned to doing

- 2025-11-22T13:32:04Z: Moved from doing to for_review

- 2025-11-22T13:40:49Z: Moved from for_review to done
