---
id: WP03.8
task_id: T040
title: Implement terminate() method in AgentService at src/services/AgentService.ts
phase: Phase 3 - User Story 1 (MVP)
lane: done
status: pending
created_at: 2025-11-21
started_at: 2025-11-22T13:37:05Z
completed_at: 2025-11-22T13:42:49Z
estimated_time: 30min
actual_time: null
depends_on: [T037, T038]
files_modified: []
---

# WP03.8: Implement terminate() method in AgentService [US1]

## Objective

Implement the terminate() method in AgentService that gracefully terminates an agent, including cleanup of resources, budget reclamation, and state finalization.

## File Paths

- `src/services/AgentService.ts`

## Work Content

1. Implement terminate() method:
   - Accept agent_id and reason parameters
   - Validate agent exists and not already terminated
   - Update agent status to 'terminated'
   - Trigger budget reclamation (via database trigger)
   - Cleanup Anthropic conversation resources
   - Update completed_at timestamp
   - Log termination event
   - Return final agent state
2. Add graceful cleanup:
   - Close open conversations
   - Release reserved resources
   - Notify parent if exists
3. Add error handling for cleanup failures
4. Support force termination option

## Acceptance Criteria

- [ ] terminate() updates agent status to 'terminated'
- [ ] Budget reclamation triggered automatically
- [ ] Anthropic conversation closed gracefully
- [ ] completed_at timestamp set
- [ ] Logging for termination events
- [ ] Error handling for cleanup failures
- [ ] Optional force termination parameter
- [ ] Returns final agent state

## Dependencies

Depends on T037 (AgentRepository) and T038 (spawn method).

## Parallel Execution

Can run in parallel with T039 (getStatus method).

## Unit Tests

Unit tests in tests/unit/services/AgentService.test.ts for terminate logic.

## Git History

**Commits**: Include [WP03.8] in commit message

## Activity Log

- 2025-11-21: Task created

- 2025-11-22T13:37:05Z: Moved from planned to doing

- 2025-11-22T13:37:05Z: Moved from doing to for_review

- 2025-11-22T13:42:49Z: Moved from for_review to done
