---
id: WP02.10
task_id: T024
title: Create budget reclamation trigger reclaim_child_budget() in migration
phase: Phase 2 - Foundational
lane: done
status: pending
created_at: 2025-11-21
started_at: 2025-11-22T13:31:20Z
completed_at: 2025-11-22T13:40:49Z
estimated_time: 30min
actual_time: null
depends_on: [T015, T016, T017]
files_modified: []
---

# WP02.10: Create budget reclamation trigger

## Objective

Create a PostgreSQL trigger function reclaim_child_budget() that automatically returns unused budget to parent when a child agent completes or is terminated.

## File Paths

- `migrations/001_initial_schema.sql` (triggers section)

## Work Content

1. Create PL/pgSQL function reclaim_child_budget():
   - Triggered AFTER UPDATE on Agent table
   - Check if agent status changed to 'completed', 'failed', or 'terminated'
   - Calculate unused budget: allocated - used
   - Find parent agent (via Hierarchy table)
   - If parent exists, add unused budget back to parent's allocated_tokens
   - Update parent's reserved_tokens (decrement)
2. Create trigger:
   ```sql
   CREATE TRIGGER budget_reclamation_trigger
   AFTER UPDATE ON Agent
   FOR EACH ROW
   WHEN (NEW.status IN ('completed', 'failed', 'terminated'))
   EXECUTE FUNCTION reclaim_child_budget();
   ```
3. Add transaction safety and logging
4. Document trigger behavior in migration comments

## Acceptance Criteria

- [ ] reclaim_child_budget() function created
- [ ] Trigger fires AFTER UPDATE on Agent status change
- [ ] Unused budget returned to parent
- [ ] Parent's reserved_tokens updated
- [ ] Transaction-safe implementation
- [ ] Only reclaims when status changes to terminal state

## Dependencies

Depends on T015 (migration file), T016 (Agent table), T017 (Budget table).

## Parallel Execution

Part of T015's migration file - sequential after Budget table defined, can be parallel with T023.

## Unit Tests

Budget reclamation validated in integration tests (Phase 7, US5).

## Git History

**Commits**: Include [WP02.10] in commit message

## Activity Log

- 2025-11-21: Task created

- 2025-11-22T13:31:20Z: Moved from planned to doing

- 2025-11-22T13:32:04Z: Moved from doing to for_review

- 2025-11-22T13:40:49Z: Moved from for_review to done
