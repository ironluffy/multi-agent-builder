---
id: WP02.7
task_id: T021
title: Define Hierarchy table with parent_id/child_id relationships
phase: Phase 2 - Foundational
lane: done
status: pending
created_at: 2025-11-21
started_at: 2025-11-22T13:31:20Z
completed_at: 2025-11-22T13:40:49Z
estimated_time: 20min
actual_time: null
depends_on: [T015]
files_modified: []
---

# WP02.7: Define Hierarchy table schema

## Objective

Define the Hierarchy junction table for tracking parent-child agent relationships, enabling hierarchical team structures and recursive queries.

## File Paths

- `migrations/001_initial_schema.sql` (Hierarchy table section)

## Work Content

1. Create Hierarchy table with columns:
   - id UUID PRIMARY KEY
   - parent_id UUID REFERENCES Agent(id) ON DELETE CASCADE NOT NULL
   - child_id UUID REFERENCES Agent(id) ON DELETE CASCADE NOT NULL
   - relationship_type VARCHAR(50) DEFAULT 'subordinate'
   - created_at TIMESTAMP DEFAULT NOW()
   - metadata JSONB
2. Add UNIQUE constraint on (parent_id, child_id) - prevent duplicates
3. Add CHECK constraint: parent_id != child_id (prevent self-reference)
4. Add indexes:
   - Index on parent_id for getChildren() queries
   - Index on child_id for getParent() queries
5. Add comments for recursive query patterns

## Acceptance Criteria

- [ ] Hierarchy table with parent_id and child_id foreign keys
- [ ] UNIQUE constraint prevents duplicate relationships
- [ ] CHECK constraint prevents self-referencing
- [ ] ON DELETE CASCADE for cleanup when agents deleted
- [ ] Indexes for efficient parent/child queries
- [ ] relationship_type field for future relationship types
- [ ] Migration comments document recursive query patterns

## Dependencies

Depends on T015 (migration file) and T016 (Agent table exists for foreign keys).

## Parallel Execution

Part of T015's migration file - sequential after T016.

## Unit Tests

Hierarchy queries validated in integration tests (Phase 4, US2).

## Git History

**Commits**: Include [WP02.7] in commit message

## Activity Log

- 2025-11-21: Task created

- 2025-11-22T13:31:20Z: Moved from planned to doing

- 2025-11-22T13:32:04Z: Moved from doing to for_review

- 2025-11-22T13:40:49Z: Moved from for_review to done
