---
id: WP04.8
task_id: T052
title: Implement getDescendants() query in HierarchyService
phase: Phase 4 - User Story 2 (Hierarchical Teams)
lane: for_review
status: pending
created_at: 2025-11-21
started_at: 2025-11-23T05:05:35Z
completed_at: null
estimated_time: 30min
actual_time: null
depends_on: ['T047']
files_modified: []
---

# WP04.8: Implement getDescendants() query in HierarchyService

## Objective

Implement getDescendants() method that returns all descendant agents for a given agent, walking down the hierarchy tree.

## File Paths

- `src/services/HierarchyService.ts`

## Work Content

1. Add getDescendants() method to HierarchyService:
   - Accept agent_id parameter
   - Use recursive CTE query to walk down hierarchy:
     ```sql
     WITH RECURSIVE descendants AS (
       SELECT child_id, 1 as level
       FROM Hierarchy WHERE parent_id = $1
       UNION ALL
       SELECT h.child_id, d.level + 1
       FROM Hierarchy h
       JOIN descendants d ON h.parent_id = d.child_id
     )
     SELECT a.* FROM Agent a
     JOIN descendants desc ON a.id = desc.child_id
     ORDER BY desc.level ASC;
     ```
2. Return array of Agent objects (breadth-first order)
3. Add optional max_depth parameter
4. Handle case where agent has no children
5. Add logging for descendant queries

## Acceptance Criteria

- [ ] getDescendants() returns all descendants
- [ ] Recursive query walks down hierarchy
- [ ] Results ordered breadth-first
- [ ] Optional max_depth parameter
- [ ] Handles agents with no children
- [ ] Returns Agent[] type

## Dependencies

Depends on T047.

## Parallel Execution

[P] Can run in parallel with other tasks after dependencies met.

## Unit Tests

Unit tests in tests/unit/services/HierarchyService.test.ts for functionality.

## Git History

**Commits**: Include [WP04.8] in commit message

## Activity Log

- 2025-11-21: Task created

- 2025-11-23T05:05:35Z: Moved from planned to doing

- 2025-11-23T05:06:27Z: Moved from doing to for_review

# Auto-detected Git commits:
- 2025-11-23T14:06:18+09:00: [GIT] 457ae70 - [WP04.8] Implement getDescendantAgents() query in HierarchyService

# Modified files (from git):
#   - src/services/HierarchyService.ts
# 
