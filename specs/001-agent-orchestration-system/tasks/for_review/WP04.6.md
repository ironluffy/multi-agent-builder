---
id: WP04.6
task_id: T050
title: Implement getHierarchyTree() recursive query in HierarchyService
phase: Phase 4 - User Story 2 (Hierarchical Teams)
lane: for_review
status: pending
created_at: 2025-11-21
started_at: 2025-11-22T18:13:50Z
completed_at: null
estimated_time: 45min
actual_time: null
depends_on: ['T047']
files_modified: []
---

# WP04.6: Implement getHierarchyTree() recursive query in HierarchyService

## Objective

Implement recursive getHierarchyTree() method that returns the complete agent hierarchy tree starting from a root agent.

## File Paths

- `src/services/HierarchyService.ts`

## Work Content

1. Add getHierarchyTree() method to HierarchyService:
   - Accept root_agent_id parameter
   - Use recursive CTE (Common Table Expression) query:
     ```sql
     WITH RECURSIVE tree AS (
       SELECT id, name, parent_id, 0 as depth
       FROM Agent WHERE id = $1
       UNION ALL
       SELECT a.id, a.name, a.parent_id, t.depth + 1
       FROM Agent a
       JOIN Hierarchy h ON a.id = h.child_id
       JOIN tree t ON h.parent_id = t.id
     )
     SELECT * FROM tree;
     ```
2. Build nested tree structure from flat results
3. Return HierarchyNode tree with children
4. Add max depth limit parameter
5. Add logging for tree queries

## Acceptance Criteria

- [ ] getHierarchyTree() returns nested tree
- [ ] Recursive CTE query implemented
- [ ] Tree structure properly nested
- [ ] Max depth limit respected
- [ ] Returns HierarchyNode type
- [ ] Performance optimized for large hierarchies

## Dependencies

Depends on T047.

## Parallel Execution

Sequential - depends on prior tasks.

## Unit Tests

Unit tests in tests/unit/services/HierarchyService.test.ts for functionality.

## Git History

**Commits**: Include [WP04.6] in commit message

## Activity Log

- 2025-11-21: Task created

- 2025-11-22T18:13:50Z: Moved from planned to doing

- 2025-11-23T04:57:49Z: Moved from doing to for_review

# Auto-detected Git commits:
- 2025-11-23T03:19:13+09:00: [GIT] d8d25e7 - [WP04.6] Implement getHierarchyTree() recursive query in HierarchyService

# Modified files (from git):
#   - src/services/HierarchyService.ts
# 
